<!-- htmllint preset="$none" -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SQL Survival 101</title>
    <link href="node_modules/remark-bekk/dist/bekk.css" type="text/css" rel="stylesheet">
  </head>
  <body class="bekk-black">
    <style>
    #framewrap { width: 135%; height: 100%; padding: 0; overflow: hidden; }
    #frame { width: 100%; height: 100%; border: none; }
    #frame {
        -ms-zoom: 0.75;
        -moz-transform: scale(0.75);
        -moz-transform-origin: 0 0;
        -o-transform: scale(0.75);
        -o-transform-origin: 0 0;
        -webkit-transform: scale(0.75);
        -webkit-transform-origin: 0 0;
    }
  </style>
    <textarea id="source">
class: front-page

# SQL Survival 101

## Hvordan leve uten Entity Framework

Geir Sagberg

29/04/2016

---

class: agenda

# Agenda

* Teknologivalg
* Connections
* Dapper
* Avanserte queries

---

# Teknologivalg

## Faktorer

* Ytelse
* PostgreSQL?
* Kompetanse

---

class: middle center

# Connections

---

# Connections - Feil

```c#
public class BadRepository
{
    public void DoSqlStuff()
    {
        using (var connection = new SqlConnection("<hardkodet>"))
        {
            connection.Open();
            // Do SQL stuff...
        }
    }
}
```

---

# Connections - Riktig

```c#
public class GoodRepository
{
    private readonly IConnectionManager connectionManager;

    public GoodRepository(IConnectionManager connectionManager)
    {
        this.connectionManager = connectionManager;
    }

    public void DoSqlStuff()
    {
        connectionManager.Execute(connection => {
            // Do SQL stuff...
        });
    }
}
```

---

# Connections - Riktig

```c#
public interface IConnectionManager
{
    void Execute(Action<IDbConnection> action);
    TResult Query<TResult>(Func<IDbConnection, TResult> func);
}
```

---

# Connections - Riktig

```c#
public class ConnectionManager : IConnectionManager
{
    private readonly IConnectionFactory connectionFactory;
    public ConnectionManager(IConnectionFactory connectionFactory) {
        this.connectionFactory = connectionFactory;
    }
    public void Execute(Action<IDbConnection> action) {
        using (var connection = CreateConnection()) {
            action(connection);
        }
    }
    public TResult Query<TResult>(Func<IDbConnection, TResult> func) {
        using (var connection = CreateConnection()) {
            return func(connection);
        }
    }
}
```

---

# Connections - Riktig

```c#
public interface IConnectionFactory
{
    IDbConnection CreateConnection();
}

public class SqlConnectionFactory : IConnectionFactory
{
    private readonly string connectionString;
    public SqlConnectionFactory(string connectionString) {
        this.connectionString = connectionString;
    }
    public IDbConnection CreateConnection() {
        IDbConnection connection = new SqlConnection(connectionString);
        connection.Open();
        return connection;
    }
}
```

---

class: middle center

# Dapper

---

# Dapper

## SqlCommand

```c#
using (var command = connection.CreateCommand()) {
    command.CommandText = "SELECT * FROM Users WHERE Name = 'Geir'";
    var reader = command.ExecuteReader();
    var user = new User {
        Id = reader.GetString(0),
        Name = reader.GetString(1)
    };
}
```

---

# Dapper

## SqlCommand

```c#
using (var command = connection.CreateCommand()) {
    command.CommandText = "SELECT * FROM Users WHERE Name = 'Geir'";
    var reader = command.ExecuteReader();
    var user = new User {
        Id = reader.GetString(0),
        Name = reader.GetString(1)
    };
}
```

## Entity Framework

```c#
var users = Context.Users.Where(u => u.Name == "Geir");
```

---

# Dapper

## SqlCommand

```c#
using (var command = connection.CreateCommand()) {
    command.CommandText = "SELECT * FROM Users WHERE Name = 'Geir'";
    var reader = command.ExecuteReader();
    var user = new User {
        Id = reader.GetString(0),
        Name = reader.GetString(1)
    };
}
```

## Entity Framework

```c#
var users = Context.Users.Where(u => u.Name == "Geir");
```

## Dapper

```c#
connection.Query<User>("SELECT * FROM Users WHERE Name = @name", new {name = "Geir"});
```

---

# Dapper Extensions

## Get og Update
```c#
var user = connection.Get<User>(1);
user.Name = "Geir";
connection.Update(user);
```

---

# Dapper Extensions

## Get og Update
```c#
var user = connection.Get<User>(1);
user.Name = "Geir";
connection.Update(user);
```

## Insert
```c#
var newUser = new User {
    Name = "Jonas"
};
connection.Insert(newUser);
```

---

# Dapper Extensions

## Get og Update
```c#
var user = connection.Get<User>(1);
user.Name = "Geir";
connection.Update(user);
```

## Insert
```c#
var newUser = new User {
    Name = "Jonas"
};
connection.Insert(newUser);
```

## Delete med predikat
```c#
connection.Delete<User>(Predicates.Field<User>(u => u.Name, Operator.Eq, "Geir"));
```

---

class: center middle

# Avanserte queries

---

# Avanserte queries

## Entity Framework

Lazy loading:

```c#
var tur = Context.Tur.Single(t => t.TurNr = "123");
var rekvisisjonHendelser = tur.Rekvisisjoner.SelectMany(r => r.Hendelser);
```

Eager loading:

```c#
var tur = Context.Tur
  .Include(t => t.Rekvisisjoner.Select(r => r.Hendelser))
  .Single(t => t.TurNr = "123")
var rekvisisjonHendelser = tur.Rekvisisjoner.SelectMany(r => r.Hendelser);
```

---

# Avanserte queries

## Dapper

```c#
var tur = connection.Query<Tur>("SELECT * FROM Tur WHERE TurNr = @turNr", 
    new {turNr = "123"}).Single();
  
tur.Rekvisisjoner = 
    connection.Query<Rekvisisjon>("SELECT * FROM Rekvisisjon WHERE tur.Id = @turId", 
    new {turId = tur.Id});
  
foreach (var rekvisisjon in tur.Rekvisisjoner) {
    rekvisisjon.Hendelser = connection.Query<Hendelse>(
        "SELECT * FROM Hendelse WHERE RekvisisjonId = @rekvisisjonId",
        new {rekvisisjonId = rekvisisjon.Id});
}
```

---

# Avanserte queries

## QueryGenerator og Slapper AutoMapper

```c#
var node = Node.OfType<Tur>
  .WithChildNode<Rekvisisjon>(t => t.Rekvisisjoner, r => r
    .WithChildNode<Hendelse>(r2 => r2.Hendelser));

var selectQuery = QueryGenerator.Select(node);

var result = connection.Query(selectQuery + " WHERE TurNr = @turNr", new {turNr = "123"});

var tur = AutoMapper.MapDynamic<Tur>(result).Single();
```

---

# QueryGenerator

```c#
var node = Node.OfType<Tur>
  .WithChildNode<Rekvisisjon>(t => t.Rekvisisjoner, r => r
    .WithChildNode<Hendelse>(r2 => r2.Hendelser));
      
var selectQuery = QueryGenerator.Select(node);

selectQuery.Should().Be(@"SELECT
  t.[Id] as Id,
  t.[SjåførNavn] as SjåførNavn,
  t.[TurNr] as TurNr
  r.[Id] as Rekvisisjoner_Id,
  r.[TurId] as Rekvisisjoner_TurId,
  h.[Id] as Rekvisisjoner_Hendelser_Id,
  h.[RekvisisjonId] as Rekvisisjoner_Hendelser_RekvisisjonId,
  h.[Timestamp] as Rekvisisjoner_Hendelser_Timestamp 
"); 

```

---

background-image: url(questions.jpg)
class: center middle

# Spørsmål?

---

class: center middle bekk-top

# Takk

Geir Sagberg

</textarea>
    <script src="node_modules/remark-bekk/vendor/remark.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      var slideshow = remark.create({
        navigation: {
          scroll: false
        },
        ratio: '16:9',
        highlightStyle: 'monokai'
      });
    </script>
  </body>
</html>
