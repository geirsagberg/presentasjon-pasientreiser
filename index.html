<!-- htmllint preset="$none" -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SQL Survival 101</title>
    <link href="node_modules/remark-bekk/dist/bekk.css" type="text/css" rel="stylesheet">
  </head>
  <body class="bekk-black">
    <style>
    #framewrap { width: 135%; height: 100%; padding: 0; overflow: hidden; }
    #frame { width: 100%; height: 100%; border: none; }
    #frame {
        -ms-zoom: 0.75;
        -moz-transform: scale(0.75);
        -moz-transform-origin: 0 0;
        -o-transform: scale(0.75);
        -o-transform-origin: 0 0;
        -webkit-transform: scale(0.75);
        -webkit-transform-origin: 0 0;
    }
  </style>
    <textarea id="source">
class: front-page

# SQL Survival 101

## Hvordan leve uten Entity Framework

Geir Sagberg

29/04/2016

---

class: agenda

# Agenda

* Databasekrav
* Problemer
* Løsninger

---

```c#
public static class QueryGenerator
{
    public static string Select<T>(string tableName = null)
    {
        return Select(new Node<T>(tableName));
    }

    //TODO: Support limit and paging.
    public static string Select(Node node)
    {
        return $@"SELECT
{GetMappingsForTree(node).ToJoinedString("," + Environment.NewLine)}
FROM {GetFromJoinsForTree(node)}";
    }

    private static IEnumerable<string> GetMappingsForTree(Node node)
    {
        return node.Flatten().SelectMany(GetMappings);
    }

    private static string GetFromJoinsForTree(Node node)
    {
        return node.Flatten().Select(GetFromJoins).ToJoinedString(Environment.NewLine);
    }

    private static string GetFromJoins(Node node)
    {
        if (node.Parent != null)
        {
            return $"LEFT JOIN {node.TableName} {node.Initials} ON {node.Parent.Initials}.Id = {node.Initials}.{node.Parent.TableName}Id";
        }
        return $"{node.TableName} {node.Initials}";
    }

    private static IEnumerable<string> GetMappings(Node node)
    {
        var initials = node.Initials;
        return node.Type.GetTableProperties().Select(prop => $"{initials}.[{prop.Name}] as {node.ParentPrefix}{prop.Name}");
    }

    private static IOrderedEnumerable<PropertyInfo> GetTableProperties(this Type dtoType)
    {
        return dtoType.GetProperties().Where(p => !p.HasAttribute<NotMappedAttribute>()).OrderBy(p => p.Name);
    }

    internal static string GetInitials(this string str)
    {
        return str.Where(char.IsUpper).ToJoinedString("").ToLowerInvariant();
    }

    public static string Insert<T>()
    {
        var table = typeof (T).GetTableName();
        var names = typeof (T).GetTableProperties().Select(p => p.Name).ToList();
        return Insert(table, names);
    }

    public static string Insert(string tableName, IEnumerable<string> columns)
    {
        var names = columns.ToList();
        var n = Environment.NewLine;
        var cols = names.Select(name => $"[{name}]").ToJoinedString("," + n);
        var vals = names.Select(name => $"@{name}").ToJoinedString("," + n);
        return $"INSERT INTO {tableName} ({n + cols + n}) VALUES ({n + vals + n})";
    }
}
```

---

# Databasekrav

## 

* Minimum 30 000 turer per dag (11 millioner turer per år)
* Ytelsen skal ikke svekkes over tid
* 50 samtidige brukere

## Overvåkning

* Systemet skal kunne overvåkes vha. Zabbix
* BEKK skal tilby konfigurasjon for Zabbix

---

background-image: url(MG_2859.jpg)
class: middle center

# Ytelse

---

# Ytelse i backend

* Helautomatiserte ytelsestester fra ende til ende
* Styrer systemet fra utsiden, og utfører jobber i riktig rekkefølge
* Bruker reelle integrasjonspunkter
* Genererer testdata basert på reelle planlagte turer
* Kjører kontroller og sender tilbakemeldinger
* Skrevet i F#

---

# Testoppsett

```f#

"Start"
  // Initialisering
  ==> "ImporterAvtaler" // NISSY
```

???

En dag om gangen, kjører tester for 24 timer. Hvert steg triggrer en jobb i hangfire

---

# Testoppsett

```f#

"Start"
  // Initialisering
  ==> "ImporterAvtaler" // NISSY
  ==> "ImporterPlanlagteTurer" // NISSY
```

---

# Testoppsett

```f#

"Start"
  // Initialisering
  ==> "ImporterAvtaler" // NISSY
  ==> "ImporterPlanlagteTurer" // NISSY
  ==> "SendInnFaktiskTur" // SonicMQ
  ==> "ImporterLagredeFiler"
```

???

Genererer SUTI av faktiske turer basert på de planlagte turene som ble importert
i forrige steg, sender de til vår innkø via Sonic

---

# Testoppsett

```f#

"Start"
  // Initialisering
  ==> "ImporterAvtaler" // NISSY
  ==> "ImporterPlanlagteTurer" // NISSY
  ==> "SendInnFaktiskTur" // SonicMQ
  ==> "ImporterLagredeFiler"
  ==> "KjørRegelmotor"
```

---

# Testoppsett

```f#

"Start"
  // Initialisering
  ==> "ImporterAvtaler" // NISSY
  ==> "ImporterPlanlagteTurer" // NISSY
  ==> "SendInnFaktiskTur" // SonicMQ
  ==> "ImporterLagredeFiler"
  ==> "KjørRegelmotor"
  ==> "Send8101Tilbakemelding" // SonicMQ
```

---

# Testoppsett

```f#

"Start"
  // Initialisering
  ==> "ImporterAvtaler" // NISSY
  ==> "ImporterPlanlagteTurer" // NISSY
  ==> "SendInnFaktiskTur" // SonicMQ
  ==> "ImporterLagredeFiler"
  ==> "KjørRegelmotor"
  ==> "Send8101Tilbakemelding" // SonicMQ
  ==> "GodkjennAlleTurerSomLiggerTilManuellBehandling"
  ==> "Send8111Tilbakemelding" // SonicMQ
```

---

# Testoppsett

```f#

"Start"
  // Initialisering
  ==> "ImporterAvtaler" // NISSY
  ==> "ImporterPlanlagteTurer" // NISSY
  ==> "SendInnFaktiskTur" // SonicMQ
  ==> "ImporterLagredeFiler"
  ==> "KjørRegelmotor"
  ==> "Send8101Tilbakemelding" // SonicMQ
  ==> "GodkjennAlleTurerSomLiggerTilManuellBehandling"
  ==> "Send8111Tilbakemelding" // SonicMQ
  ==> "SendEgenandel" // HELFO
```

---

# Testoppsett

```f#

"Start"
  // Initialisering
  ==> "ImporterAvtaler" // NISSY
  ==> "ImporterPlanlagteTurer" // NISSY
  ==> "SendInnFaktiskTur" // SonicMQ
  ==> "ImporterLagredeFiler"
  ==> "KjørRegelmotor"
  ==> "Send8101Tilbakemelding" // SonicMQ
  ==> "GodkjennAlleTurerSomLiggerTilManuellBehandling"
  ==> "Send8111Tilbakemelding" // SonicMQ
  ==> "SendEgenandel" // HELFO
  ==> "Send8199Oppgjør" // SonicMQ
```

???

Gjenta stegene for den mengden dager man vil kjøre tester for. Har skrevet
script for å gjøre dette.

---

# Pros og cons

## Fordeler

* Får stresstestet integrasjonspunkter
* Lett å sjekke om databasekoden vår har svakheter
* Lett å sjekke ytelse over tid

## Ulemper

* Får ikke testet alle caser
* Positiv tilnærming

---

# Ytelse i frontend

* Bruker Gatling til å teste API-endepunktene våre
* Simulerer så mange samtidige brukere som vi vil
* Automatisk generering av grafer og andre visualiseringer av ytelsen

---

# Ytelse i frontend

<div id="framewrap">
  <iframe id="frame" width="100%" height="80%" src="ctrlapisimulation/index.html"></iframe>
</div>

---

class: cols three

# Resultater

* Vi har funnet _mange_ deadlocks og andre problemer med vår egen kode
* Vi har funnet _mange_ problemer med integrasjonene
* Vi har dokumentert at systemet vårt kan takle en last som er mye høyere enn kravet
* I påsken kjørte vi ytelsestester på over 5 år med testdata i løpet av 10
dager uten nevneverdige feil.

## Hva gjenstår?

* Vi har enda ikke kjørt backendtester samtidig som frontendtester
* Testing i prodmiljø

---

background-image: url(surveillance.jpg)
class: middle center

# Overvåkning

---

# Zabbix

* Overvåkningssystem som brukes og driftes av NHN
* Kan vise ytelsesdata og overvåkningsdata over tid (RAM-bruk etc.)
* Lar oss definere alarmer ved feil.

???

Vi skal konfigurere zabbix

---

# Helsesjekker

Er integrasjoner oppe? Hva er responstiden på forsiden?
* Vi har en rekke helsesjekker som rapporteres til Zabbix
* Avvik genererer en alarm i Zabbix.
  * SQL server
  * HELFO
  * Sonic



* Annen data som rapporteres
  * Antall turer vi har behandlet
  * Antall turer vi har importert
  * osv...

---

# Oppsett av Zabbix

* Vårt system rapporterer status via performance countere i Windows.
* XML fil definerer hvilke performance countere Zabbix lytter til.
* XML er automatisk generert basert på annoteringer i kildekoden.

```c#
// C#
[ZabbixTemplate(TurerBehandletCounterName)]
public static FeatureToggledPerfCounterDecorator TurerBehandlet() =>
  new FeatureToggledPerfCounterDecorator(TurerBehandletCounterName);
```

```xml
<!-- XML -->
<item>
  <name>Turer behandlet</name>
  <type>0</type>
  <multiplier>0</multiplier>
  ...
</item>
```

???

Hvordan får vi konfigurert dataene som Zabbix skal ha?
Vårt system integrerer med windows performancecounters, zabbix-agent på
nodene kan lese disse counterene. Zabbix-agentene må konfigureres vha XML.

Selve XML-filene må manuelt importeres i Zabbix, vi har ikke klart å automatisere
det steget.

---

class: center middle bekk-top

# Demo

---

background-image: url(questions.jpg)
class: center middle bekk-top

# Spørsmål?

---

class: center middle bekk-top

# Takk

Dag Stuan

</textarea>
    <script src="node_modules/remark-bekk/vendor/remark.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      var slideshow = remark.create({
        navigation: {
          scroll: false
        },
        ratio: '16:9',
        highlightStyle: 'monokai'
      });
    </script>
  </body>
</html>
